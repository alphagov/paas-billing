# ADR003: Simple SQL

## Status

Accepted

## Context

The current billing system uses large, complex queries, some Postgres-specific SQL features (e.g. date range types and operators) and dynamic SQL. The dynamic SQL is used to calculate bills for each tenant and resource; each row of data is calculated separately using dynamic SQL.

The new Paas billing code to calculate tenants' bills ([`calculate_bill`](../../billing-db/sprocs/calculate_bill.sql)) is performance-critical and uses lots of smaller, simple queries. It does a lot of processing, can process a lot of data and should be changed as little as possible since it is already running near-optimally. It is running near-optimally because it uses simple SQL constructs which are easily interpreted by Postgres.

## Decision

1. We should use a greater number of smaller, simple SQL queries rather than large, complex SQL queries, since:

    - it is more likely that the Postgres optimiser will plan the queries optimally, so the queries run more quickly
    - the code is easier to understand for new team members coming from a non-Postgres background

2. Row-based processing (whereby each row of data is processed sequentially) currently run using dynamic SQL in the original Paas billing is no longer used in the new Paas billing system since:

    - is does not scale well with increasing numbers of tenants and numbers of services/resources that tenants provision and can be slow
    - we cannot calculate tenant bills on-demand because row-based processing is too slow. This means we cannot easily calculate bills between any 2 dates/times which is a future functional requirement

## Consequences

The Paas billing database SQL code will be more maintainable in the future and less likely to have future performance problems.
